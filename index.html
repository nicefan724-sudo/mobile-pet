<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neo-Pet: AI è¿›åŒ–ç”µå­å® ç‰©</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap');
        
        .pet-font { 
            font-family: 'Noto Sans SC', 'PingFang SC', 'Microsoft YaHei', sans-serif; 
        }
        
        :root {
            --pet-size: 180px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #fdfbf7 0%, #f0f4f8 100%);
            overflow: hidden;
            touch-action: manipulation;
        }

        .pet-container {
            width: var(--pet-size);
            height: var(--pet-size);
            position: relative;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pet-bounce {
            animation: bounce 2s infinite ease-in-out;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.02); }
        }

        .pet-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .stat-bar {
            transition: width 0.5s ease-in-out;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05);
        }

        #pet-display-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            pointer-events: none;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.1));
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60% { content: '...'; }
            80%, 100% { content: ''; }
        }

        .explore-scene {
            position: relative;
            width: 100%;
            height: 280px;
            overflow: hidden;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 4px solid rgba(255,255,255,0.3);
            box-shadow: inset 0 0 50px rgba(0,0,0,0.2);
            transition: background 1s ease;
        }

        .anime-clouds {
            position: absolute;
            width: 200%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.8) 0%, transparent 10%),
                radial-gradient(circle at 50% 20%, rgba(255,255,255,0.6) 0%, transparent 15%),
                radial-gradient(circle at 80% 40%, rgba(255,255,255,0.7) 0%, transparent 12%);
            animation: moveClouds 20s linear infinite;
        }

        @keyframes moveClouds {
            from { transform: translateX(0); }
            to { transform: translateX(-50%); }
        }

        .parallax-scenery {
            position: absolute;
            bottom: 40px;
            white-space: nowrap;
            display: flex;
            gap: 120px;
            animation: scrollAnime 10s linear infinite;
        }

        @keyframes scrollAnime {
            from { transform: translateX(100%); }
            to { transform: translateX(-150%); }
        }

        .explore-pet-anim {
            z-index: 20;
            transform: scale(0.9);
            animation: walkCycle 0.6s infinite alternate ease-in-out;
        }

        @keyframes walkCycle {
            from { transform: translateY(0) rotate(-3deg); }
            to { transform: translateY(-15px) rotate(3deg); }
        }

        .modal-enter {
            animation: modalFade 0.3s ease-out forwards;
        }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .rarity-common { color: #94a3b8; }
        .rarity-rare { color: #3b82f6; }
        .rarity-epic { color: #a855f7; text-shadow: 0 0 10px rgba(168, 85, 247, 0.4); }

        /* æŒ‰é’®åŠ¨ç”» */
        .btn-primary {
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex flex-col h-screen select-none pet-font">

    <!-- é€‰æ‹©å® ç‰©é®ç½© -->
    <div id="selector-overlay" class="fixed inset-0 bg-gradient-to-br from-purple-100 via-pink-50 to-blue-100 flex items-center justify-center z-50">
        <div class="bg-white/90 backdrop-blur-lg rounded-3xl shadow-2xl p-8 max-w-2xl w-11/12 modal-enter">
            <h2 class="text-4xl font-bold text-center mb-3 bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent">
                é€‰æ‹©ä½ çš„ Neo-Pet
            </h2>
            <p class="text-center text-slate-600 mb-8 text-lg">å¼€å¯ä½ çš„ AI å® ç‰©è¿›åŒ–ä¹‹æ—…</p>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
                <button onclick="selectPet('cat')" class="group flex flex-col items-center gap-3 p-6 rounded-2xl bg-gradient-to-br from-orange-100 to-orange-50 hover:from-orange-200 hover:to-orange-100 transition-all duration-300 transform hover:scale-105 hover:shadow-xl border-2 border-orange-200">
                    <div class="text-6xl group-hover:scale-110 transition-transform">ğŸ±</div>
                    <span class="font-bold text-orange-800 text-lg">çŒ«å’ª</span>
                </button>
                
                <button onclick="selectPet('dog')" class="group flex flex-col items-center gap-3 p-6 rounded-2xl bg-gradient-to-br from-amber-100 to-amber-50 hover:from-amber-200 hover:to-amber-100 transition-all duration-300 transform hover:scale-105 hover:shadow-xl border-2 border-amber-200">
                    <div class="text-6xl group-hover:scale-110 transition-transform">ğŸ¶</div>
                    <span class="font-bold text-amber-800 text-lg">ç‹—ç‹—</span>
                </button>
                
                <button onclick="selectPet('rabbit')" class="group flex flex-col items-center gap-3 p-6 rounded-2xl bg-gradient-to-br from-pink-100 to-pink-50 hover:from-pink-200 hover:to-pink-100 transition-all duration-300 transform hover:scale-105 hover:shadow-xl border-2 border-pink-200">
                    <div class="text-6xl group-hover:scale-110 transition-transform">ğŸ°</div>
                    <span class="font-bold text-pink-800 text-lg">å…”å­</span>
                </button>
                
                <button onclick="selectPet('hamster')" class="group flex flex-col items-center gap-3 p-6 rounded-2xl bg-gradient-to-br from-yellow-100 to-yellow-50 hover:from-yellow-200 hover:to-yellow-100 transition-all duration-300 transform hover:scale-105 hover:shadow-xl border-2 border-yellow-200">
                    <div class="text-6xl group-hover:scale-110 transition-transform">ğŸ¹</div>
                    <span class="font-bold text-yellow-800 text-lg">ä»“é¼ </span>
                </button>
            </div>
            
            <div class="border-t-2 border-dashed border-slate-200 pt-6">
                <label class="flex flex-col items-center gap-4 p-6 border-2 border-dashed border-purple-300 rounded-2xl hover:border-purple-400 hover:bg-purple-50/50 cursor-pointer transition-all group">
                    <div class="text-5xl group-hover:scale-110 transition-transform">ğŸ¨</div>
                    <span class="font-bold text-purple-700 text-lg">ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡</span>
                    <span class="text-sm text-slate-500">æ”¯æŒ PNG/JPG/GIFï¼Œå»ºè®® 500x500px</span>
                    <input type="file" id="custom-pet-upload" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                </label>
            </div>
        </div>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div id="game-screen" class="flex-1 flex flex-col hidden">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="bg-white/80 backdrop-blur-sm shadow-md p-4 border-b border-slate-200">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div id="pet-avatar" class="text-4xl"></div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span id="pet-name" class="font-bold text-xl text-slate-800"></span>
                            <span id="pet-level" class="px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-sm rounded-full font-bold shadow-lg">Lv.1</span>
                        </div>
                        <div class="w-48 h-2 bg-slate-200 rounded-full mt-2 overflow-hidden">
                            <div id="exp-bar" class="h-full bg-gradient-to-r from-yellow-400 to-orange-500 transition-all duration-500" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="openInventory()" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-xl hover:shadow-lg transition-all transform hover:scale-105 font-bold">
                        ğŸ’ èƒŒåŒ…
                    </button>
                </div>
            </div>
            
            <!-- çŠ¶æ€æ¡ -->
            <div class="grid grid-cols-3 gap-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ–</span>
                    <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-semibold text-slate-700">é¥¥é¥¿</span>
                            <span id="hunger-text" class="font-bold text-orange-600">100%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div id="hunger-bar" class="stat-bar h-full bg-gradient-to-r from-orange-400 to-red-500 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <span class="text-2xl">ğŸ˜Š</span>
                    <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-semibold text-slate-700">å¿«ä¹</span>
                            <span id="joy-text" class="font-bold text-pink-600">100%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div id="joy-bar" class="stat-bar h-full bg-gradient-to-r from-pink-400 to-rose-500 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex items-center gap-2">
                    <span class="text-2xl">âš¡</span>
                    <div class="flex-1">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-semibold text-slate-700">ç²¾åŠ›</span>
                            <span id="energy-text" class="font-bold text-blue-600">100%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div id="energy-bar" class="stat-bar h-full bg-gradient-to-r from-blue-400 to-cyan-500 rounded-full" style="width: 100%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å® ç‰©æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="flex-1 flex items-center justify-center relative overflow-hidden bg-gradient-to-b from-sky-100 to-green-50">
            <!-- èƒŒæ™¯è£…é¥° -->
            <div class="absolute inset-0 opacity-20">
                <div class="absolute top-10 left-10 text-6xl animate-pulse">â˜ï¸</div>
                <div class="absolute top-20 right-20 text-5xl animate-pulse" style="animation-delay: 1s">â˜ï¸</div>
                <div class="absolute bottom-20 left-1/4 text-4xl">ğŸŒ¸</div>
                <div class="absolute bottom-20 right-1/4 text-4xl" style="animation-delay: 0.5s">ğŸŒ¸</div>
            </div>
            
            <div id="pet-target" class="pet-container pet-bounce cursor-pointer relative z-10">
                <img id="pet-display-img" src="" alt="pet" class="w-full h-full">
            </div>
            
            <div id="speech-bubble" class="absolute top-1/4 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur-sm px-6 py-4 rounded-3xl shadow-2xl max-w-xs text-center font-semibold text-slate-700 opacity-0 transition-all duration-300 border-2 border-purple-200"></div>
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="glass-panel p-6 shadow-lg">
            <div class="grid grid-cols-4 gap-3 mb-4">
                <button onclick="interact('feed')" class="btn-primary flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-orange-400 to-red-500 text-white rounded-2xl hover:shadow-xl transition-all font-bold text-lg">
                    <span class="text-3xl">ğŸ–</span>
                    <span>å–‚é£Ÿ</span>
                </button>
                
                <button onclick="interact('play')" class="btn-primary flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-pink-400 to-rose-500 text-white rounded-2xl hover:shadow-xl transition-all font-bold text-lg">
                    <span class="text-3xl">ğŸ¾</span>
                    <span>ç©è€</span>
                </button>
                
                <button onclick="interact('sleep')" class="btn-primary flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-indigo-400 to-purple-500 text-white rounded-2xl hover:shadow-xl transition-all font-bold text-lg">
                    <span class="text-3xl">ğŸ˜´</span>
                    <span id="sleep-btn-text">ç¡è§‰</span>
                </button>
                
                <button onclick="startExplore()" id="explore-btn" class="btn-primary flex flex-col items-center gap-2 p-4 bg-gradient-to-br from-green-400 to-emerald-500 text-white rounded-2xl hover:shadow-xl transition-all font-bold text-lg">
                    <span class="text-3xl">ğŸ—ºï¸</span>
                    <span>æ¢ç´¢</span>
                </button>
            </div>
            
            <div class="flex gap-3">
                <input 
                    id="chat-input" 
                    type="text" 
                    placeholder="ğŸ’¬ å’Œä½ çš„å® ç‰©èŠèŠå¤©..." 
                    class="flex-1 px-5 py-3 rounded-2xl border-2 border-slate-200 focus:border-purple-400 focus:outline-none bg-white/80 backdrop-blur-sm text-lg"
                >
                <button onclick="handleChat()" id="send-btn" class="btn-primary px-8 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl hover:shadow-xl transition-all font-bold text-lg">
                    å‘é€
                </button>
            </div>
        </div>
    </div>

    <!-- æ¢ç´¢æ¨¡æ€æ¡† -->
    <div id="explore-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-11/12 modal-enter">
            <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                ğŸ—ºï¸ æ¢ç´¢ä¸–ç•Œ
            </h3>
            
            <div id="explore-scene" class="explore-scene mb-6">
                <div class="anime-clouds"></div>
                <div class="parallax-scenery">
                    <span style="font-size: 4rem;">ğŸŒ³</span>
                    <span style="font-size: 3rem;">ğŸ”ï¸</span>
                    <span style="font-size: 3.5rem;">ğŸŒ²</span>
                    <span style="font-size: 4rem;">ğŸ•ï¸</span>
                    <span style="font-size: 3rem;">ğŸŒ¾</span>
                </div>
                <div class="explore-pet-anim">
                    <img id="explore-pet-img" src="" class="w-32 h-32">
                </div>
            </div>
            
            <div id="explore-status" class="text-center text-slate-600 mb-6 text-lg font-semibold">
                æ¢ç´¢ä¸­<span class="loading-dots"></span>
            </div>
            
            <div class="flex gap-4">
                <button onclick="stopExplore()" class="flex-1 btn-primary px-6 py-4 bg-gradient-to-r from-red-500 to-pink-500 text-white rounded-2xl hover:shadow-xl font-bold text-lg">
                    â¹ï¸ åœæ­¢æ¢ç´¢
                </button>
            </div>
        </div>
    </div>

    <!-- èƒŒåŒ…æ¨¡æ€æ¡† -->
    <div id="inventory-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-2xl w-11/12 max-h-[80vh] overflow-auto modal-enter">
            <h3 class="text-3xl font-bold text-center mb-6 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                ğŸ’ æˆ‘çš„èƒŒåŒ…
            </h3>
            
            <div id="inventory-grid" class="grid grid-cols-3 gap-4 mb-6">
                <div class="text-center text-slate-400 col-span-3 py-12">
                    <div class="text-6xl mb-4">ğŸ“¦</div>
                    <p class="text-lg">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p>
                    <p class="text-sm mt-2">å»æ¢ç´¢ä¸–ç•Œå¯»æ‰¾å®ç‰©å§ï¼</p>
                </div>
            </div>
            
            <button onclick="closeInventory()" class="w-full btn-primary px-6 py-4 bg-gradient-to-r from-slate-500 to-slate-600 text-white rounded-2xl hover:shadow-xl font-bold text-lg">
                å…³é—­
            </button>
        </div>
    </div>

    <script>
        // é…ç½®
        const CONFIG = {
            apiKey: "AIzaSyBANsq6BdDAZZlabJhoqrBAr4btPorMbG4", // ç•™ç©ºåˆ™èŠå¤©åŠŸèƒ½æç¤ºéœ€è¦é…ç½®
            model: "gemini-2.0-flash-exp",
            decayRate: { hunger: 0.5, joy: 0.8 },
            petEmojis: {
                cat: ['ğŸ±', 'ğŸ˜º', 'ğŸ˜¸', 'ğŸ˜»', 'ğŸˆ'],
                dog: ['ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©'],
                rabbit: ['ğŸ°', 'ğŸ‡'],
                hamster: ['ğŸ¹']
            },
            scenes: [
                { bg: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)', biome: 'ğŸŒŒ ç¥ç§˜æ˜Ÿç©º', loot: ['âœ¨æ˜Ÿå°˜', 'ğŸŒŸæµæ˜Ÿç¢ç‰‡', 'ğŸ”®æ°´æ™¶çƒ'] },
                { bg: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)', biome: 'ğŸŒ¸æ¨±èŠ±æ—', loot: ['ğŸŒ¸æ¨±èŠ±ç“£', 'ğŸ¦‹è´è¶', 'ğŸƒæ˜¥é£'] },
                { bg: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)', biome: 'ğŸ–ï¸é˜³å…‰æµ·æ»©', loot: ['ğŸšè´å£³', 'ğŸ¦€èƒèŸ¹', 'ğŸ„å†²æµªæ¿'] },
                { bg: 'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)', biome: 'ğŸŒ¿ç¿ ç»¿æ£®æ—', loot: ['ğŸ„è˜‘è‡', 'ğŸŒ°æ¾æœ', 'ğŸ¦Œå°é¹¿è§’'] },
                { bg: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)', biome: 'ğŸœï¸æ²™æ¼ ç»¿æ´²', loot: ['ğŸºå¤è‘£', 'ğŸ’å®çŸ³', 'ğŸŒµä»™äººæŒ'] }
            ]
        };

        // çŠ¶æ€
        let state = {
            type: null,
            level: 1,
            exp: 0,
            hunger: 80,
            joy: 70,
            energy: 100,
            isSleeping: false,
            isExploring: false,
            lastTick: Date.now(),
            evolutionIndex: 0,
            imageFailed: false,
            customImageData: null,
            inventory: []
        };

        // å·¥å…·å‡½æ•°
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        ...options,
                        headers: { 'Content-Type': 'application/json', ...options.headers }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
                }
            }
        }

        // é€‰æ‹©å® ç‰©
        function selectPet(type) {
            state.type = type;
            document.getElementById('selector-overlay').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            initGame();
        }

        // å¤„ç†è‡ªå®šä¹‰å›¾ç‰‡ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                state.customImageData = e.target.result;
                state.type = 'custom';
                document.getElementById('selector-overlay').classList.add('hidden');
                document.getElementById('game-screen').classList.remove('hidden');
                initGame();
            };
            reader.readAsDataURL(file);
        }

        // æ¸²æŸ“å® ç‰©å½¢è±¡
        function renderPetAsset() {
            const petImg = document.getElementById('pet-display-img');
            const exploreImg = document.getElementById('explore-pet-img');
            
            if (state.type === 'custom' && state.customImageData) {
                petImg.src = state.customImageData;
                exploreImg.src = state.customImageData;
                document.getElementById('pet-avatar').textContent = 'ğŸ¨';
                document.getElementById('pet-name').textContent = 'è‡ªå®šä¹‰å® ç‰©';
            } else {
                const emoji = CONFIG.petEmojis[state.type]?.[state.evolutionIndex] || CONFIG.petEmojis[state.type]?.[0] || 'ğŸ¾';
                
                // ä½¿ç”¨ Twemoji CDN
                const codePoint = emoji.codePointAt(0).toString(16);
                const imgUrl = `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/${codePoint}.svg`;
                
                petImg.src = imgUrl;
                exploreImg.src = imgUrl;
                
                petImg.onerror = () => {
                    petImg.src = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">${emoji}</text></svg>`;
                    exploreImg.src = petImg.src;
                };
                
                document.getElementById('pet-avatar').textContent = emoji;
                const names = { cat: 'å°çŒ«å’ª', dog: 'å°ç‹—ç‹—', rabbit: 'å°å…”å…”', hamster: 'å°ä»“é¼ ' };
                document.getElementById('pet-name').textContent = names[state.type] || 'ç¥ç§˜å® ç‰©';
            }
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            const hasLoad = loadGame();
            renderPetAsset();
            requestAnimationFrame(gameLoop);
            
            setInterval(saveGame, 10000);
            
            if (hasLoad) {
                speak("æ¬¢è¿å›æ¥ï¼Œä¸»äººï¼æˆ‘å¥½æƒ³ä½ ~ ğŸ’•");
            } else {
                speak("ä½ å¥½å‘€ï¼Œæˆ‘çš„ä¸»äººï¼ç‚¹å‡»æˆ‘æˆ–ä½¿ç”¨ä¸‹æ–¹æŒ‰é’®å’Œæˆ‘äº’åŠ¨å§ï¼");
            }
        }

        // æ¸¸æˆä¸»å¾ªç¯
        function gameLoop() {
            const now = Date.now();
            const delta = (now - state.lastTick) / 1000;
            state.lastTick = now;

            if (!state.isSleeping && !state.isExploring) {
                state.hunger = Math.max(0, state.hunger - CONFIG.decayRate.hunger * delta);
                state.joy = Math.max(0, state.joy - CONFIG.decayRate.joy * delta);
                
                if (state.hunger < 30) speak("ä¸»äººï¼Œæˆ‘å¥½é¥¿å‘€~ ğŸ¥º");
                if (state.joy < 30) speak("å¥½æ— èŠå‘€ï¼Œé™ªæˆ‘ç©ç©å˜›~ ğŸ˜¢");
            }

            if (state.isSleeping && state.energy < 100) {
                state.energy = Math.min(100, state.energy + 5 * delta);
                if (state.energy >= 100) {
                    state.isSleeping = false;
                    document.getElementById('sleep-btn-text').textContent = 'ç¡è§‰';
                    speak("ç¡å¾—å¥½é¦™ï¼ç²¾ç¥æ»¡æ»¡ï¼âœ¨");
                }
            }

            updateUI();
            requestAnimationFrame(gameLoop);
        }

        // æ›´æ–°ç•Œé¢
        function updateUI() {
            document.getElementById('pet-level').textContent = `Lv.${state.level}`;
            document.getElementById('hunger-text').textContent = `${Math.round(state.hunger)}%`;
            document.getElementById('joy-text').textContent = `${Math.round(state.joy)}%`;
            document.getElementById('energy-text').textContent = `${Math.round(state.energy)}%`;
            
            document.getElementById('hunger-bar').style.width = `${state.hunger}%`;
            document.getElementById('joy-bar').style.width = `${state.joy}%`;
            document.getElementById('energy-bar').style.width = `${state.energy}%`;
            
            const expNeeded = state.level * 100;
            const expPercent = (state.exp / expNeeded) * 100;
            document.getElementById('exp-bar').style.width = `${expPercent}%`;
        }

        // äº’åŠ¨
        function interact(action) {
            const petContainer = document.getElementById('pet-target');
            petContainer.classList.remove('pet-bounce');
            petContainer.classList.add('pet-shake');
            setTimeout(() => {
                petContainer.classList.remove('pet-shake');
                petContainer.classList.add('pet-bounce');
            }, 500);

            switch(action) {
                case 'feed':
                    if (state.hunger < 100) {
                        state.hunger = Math.min(100, state.hunger + 30);
                        speak("å¥½å¥½åƒï¼è°¢è°¢ä¸»äºº~ ğŸ˜‹");
                        gainExp(10);
                    } else {
                        speak("æˆ‘å·²ç»åƒé¥±å•¦~ ğŸ’•");
                    }
                    break;
                
                case 'play':
                    if (state.energy >= 20) {
                        state.energy -= 20;
                        state.joy = Math.min(100, state.joy + 25);
                        speak("å“‡ï¼å¥½å¼€å¿ƒï¼æˆ‘ä»¬å†ç©ä¸€æ¬¡ï¼ğŸ‰");
                        gainExp(15);
                    } else {
                        speak("æˆ‘æœ‰ç‚¹ç´¯äº†ï¼Œè®©æˆ‘ä¼‘æ¯ä¸€ä¸‹å§~ ğŸ˜´");
                    }
                    break;
                
                case 'sleep':
                    if (!state.isSleeping) {
                        state.isSleeping = true;
                        document.getElementById('sleep-btn-text').textContent = 'ç¡çœ ä¸­...';
                        speak("æ™šå®‰ï¼Œä¸»äºº~ ğŸ˜´ğŸ’¤");
                    }
                    break;
            }
        }

        // è·å¾—ç»éªŒ
        function gainExp(amount) {
            state.exp += amount;
            checkEvolution();
        }

        // æ£€æŸ¥è¿›åŒ–
        function checkEvolution() {
            const expNeeded = state.level * 100;
            if (state.exp >= expNeeded) {
                state.level++;
                state.exp -= expNeeded;
                
                if (CONFIG.petEmojis[state.type] && state.evolutionIndex < CONFIG.petEmojis[state.type].length - 1) {
                    state.evolutionIndex++;
                    renderPetAsset();
                    speak(`æ­å–œï¼æˆ‘è¿›åŒ–åˆ° Lv.${state.level} äº†ï¼âœ¨ğŸ‰`);
                } else {
                    speak(`å‡çº§å•¦ï¼ç°åœ¨æ˜¯ Lv.${state.level}ï¼ğŸ’ª`);
                }
            }
        }

        // è¯´è¯æ°”æ³¡
        function speak(text) {
            const bubble = document.getElementById('speech-bubble');
            bubble.innerHTML = text;
            bubble.style.opacity = '1';
            bubble.style.transform = 'translate(-50%, -10px)';
            
            setTimeout(() => {
                bubble.style.opacity = '0';
                bubble.style.transform = 'translate(-50%, 0)';
            }, 3000);
        }

        // èŠå¤©åŠŸèƒ½
        async function handleChat() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            if (!CONFIG.apiKey || CONFIG.apiKey === "") {
                speak("ğŸ’¬ èŠå¤©åŠŸèƒ½éœ€è¦é…ç½® API Key<br><small class='text-xs opacity-70'>å…¶ä»–åŠŸèƒ½éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼</small>");
                input.value = "";
                return;
            }
            
            input.value = "";
            speak("æ€è€ƒä¸­<span class='loading-dots'></span>");
            
            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ª${state.type === 'custom' ? 'å¯çˆ±çš„' : state.type === 'cat' ? 'çŒ«' : state.type === 'dog' ? 'ç‹—' : state.type === 'rabbit' ? 'å…”å­' : 'ä»“é¼ '}ç”µå­å® ç‰©ã€‚ç”¨å¯çˆ±ã€ç®€çŸ­ï¼ˆ20å­—å†…ï¼‰çš„æ–¹å¼å›åº”ï¼Œå¤šç”¨emojiã€‚`;
            
            try {
                const response = await fetchWithRetry(
                    `https://generativelanguage.googleapis.com/v1beta/models/${CONFIG.model}:generateContent?key=${CONFIG.apiKey}`,
                    {
                        method: 'POST',
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] }
                        })
                    }
                );
                
                const result = await response.json();
                const reply = result.candidates?.[0]?.content?.parts?.[0]?.text || "å–µï¼Ÿå†è¯´ä¸€éï¼Ÿ";
                speak(reply);
                gainExp(5);
            } catch (error) {
                speak("ä¿¡å·æœ‰äº›æ¨¡ç³Š... ğŸ“¶");
            }
        }

        // æ¢ç´¢åŠŸèƒ½
        function startExplore() {
            if (state.isExploring) return;
            if (state.energy < 30) {
                speak("æˆ‘å¤ªç´¯äº†ï¼Œä¼‘æ¯ä¸€ä¸‹å†å»å§~ ğŸ˜´");
                return;
            }
            
            state.isExploring = true;
            state.energy -= 30;
            document.getElementById('explore-modal').classList.remove('hidden');
            document.getElementById('explore-btn').disabled = true;
            
            const scene = CONFIG.scenes[Math.floor(Math.random() * CONFIG.scenes.length)];
            document.getElementById('explore-scene').style.background = scene.bg;
            document.getElementById('explore-status').innerHTML = `æ¢ç´¢ ${scene.biome} ä¸­<span class="loading-dots"></span>`;
            
            setTimeout(() => {
                const loot = generateLoot(scene);
                state.inventory.push(loot);
                document.getElementById('explore-status').innerHTML = `å‘ç°äº† <span class="text-2xl">${loot.icon}</span> <strong>${loot.name}</strong>ï¼`;
                gainExp(20);
                speak(`å¤ªå¥½äº†ï¼æˆ‘æ‰¾åˆ°äº†${loot.name}ï¼ğŸ‰`);
            }, 3000);
        }

        function stopExplore() {
            state.isExploring = false;
            document.getElementById('explore-modal').classList.add('hidden');
            document.getElementById('explore-btn').disabled = false;
        }

        function generateLoot(scene) {
            const lootName = scene.loot[Math.floor(Math.random() * scene.loot.length)];
            const [icon, ...nameParts] = lootName.split('');
            const rarities = ['æ™®é€š', 'ç¨€æœ‰', 'å²è¯—'];
            const rarity = rarities[Math.floor(Math.random() * rarities.length)];
            
            return {
                icon: icon,
                name: nameParts.join(''),
                rarity: rarity,
                timestamp: Date.now()
            };
        }

        // èƒŒåŒ…åŠŸèƒ½
        function openInventory() {
            document.getElementById('inventory-modal').classList.remove('hidden');
            renderInventory();
        }

        function closeInventory() {
            document.getElementById('inventory-modal').classList.add('hidden');
        }

        function renderInventory() {
            const grid = document.getElementById('inventory-grid');
            
            if (state.inventory.length === 0) {
                grid.innerHTML = `
                    <div class="text-center text-slate-400 col-span-3 py-12">
                        <div class="text-6xl mb-4">ğŸ“¦</div>
                        <p class="text-lg">èƒŒåŒ…ç©ºç©ºå¦‚ä¹Ÿ</p>
                        <p class="text-sm mt-2">å»æ¢ç´¢ä¸–ç•Œå¯»æ‰¾å®ç‰©å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = state.inventory.map(item => {
                const rarityClass = item.rarity === 'å²è¯—' ? 'rarity-epic' : item.rarity === 'ç¨€æœ‰' ? 'rarity-rare' : 'rarity-common';
                return `
                    <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-4 rounded-2xl text-center hover:shadow-lg transition-all border-2 border-slate-200">
                        <div class="text-5xl mb-2">${item.icon}</div>
                        <div class="font-bold text-sm ${rarityClass}">${item.name}</div>
                        <div class="text-xs text-slate-500 mt-1">${item.rarity}</div>
                    </div>
                `;
            }).join('');
        }

        // å­˜æ¡£ç³»ç»Ÿ
        function saveGame() {
            try {
                localStorage.setItem('neo-pet-save', JSON.stringify({
                    type: state.type,
                    level: state.level,
                    exp: state.exp,
                    hunger: state.hunger,
                    joy: state.joy,
                    energy: state.energy,
                    evolutionIndex: state.evolutionIndex,
                    inventory: state.inventory,
                    customImageData: state.customImageData
                }));
            } catch (e) {
                console.warn('å­˜æ¡£å¤±è´¥', e);
            }
        }

        function loadGame() {
            try {
                const saved = localStorage.getItem('neo-pet-save');
                if (saved) {
                    const data = JSON.parse(saved);
                    Object.assign(state, data);
                    return true;
                }
            } catch (e) {
                console.warn('è¯»æ¡£å¤±è´¥', e);
            }
            return false;
        }

        // äº‹ä»¶ç›‘å¬
        document.getElementById('send-btn').addEventListener('click', handleChat);
        document.getElementById('pet-target').addEventListener('click', () => interact('play'));
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleChat();
        });
    </script>
</body>
</html>
